{# Get sources to loop through #}
{% set sourceList = config.siteId.split(',') %}
{% set sourceTable = sources[0].dependencies[0].node.name %}
{% set orgSourceLocation = sources[0].dependencies[0].node.location.name %}
{% set orgFullyQualifiedSourceTableName = ref_raw(orgSourceLocation, sourceTable) %}

{% for sourceValue in sourceList %}
    {# Target Table Location and Name #}
    {% set sourceLocation = sourceValue %}
    {% set sourceTableDatabaseName = storageLocations | selectattr('name', 'equalto', sourceLocation) | map(attribute='database') | first %}
    {% set sourceTableSchemaName = storageLocations | selectattr('name', 'equalto', sourceLocation) | map(attribute='schema') | first %}

    {% set fullyQualifiedSourceTableName = '"' + sourceTableDatabaseName + '"."' + sourceTableSchemaName + '"."' + sourceTable + '"' %}

    {% set joinValue = sources[0].join | replace('<SITEID>', sourceValue) %}
    {% set joinValue = joinValue | replace(orgFullyQualifiedSourceTableName, fullyQualifiedSourceTableName) %}

    {{ stage( sourceValue + ' Source Load' | string ) }}
        INSERT INTO {{ ref_no_link(node.location.name, node.name) }}
            (
                {% for col in columns %}
                    "{{ col.name }}"
                    {%- if not loop.last -%},{% endif %}
                {% endfor %}
            )
            SELECT
            {% for col in sources[0].columns %}
                {{ get_source_transform(col) }} AS "{{ col.name }}"
                {%- if not loop.last -%}, {% endif %}
            {% endfor %}

        {{ joinValue }}
{% endfor %}
