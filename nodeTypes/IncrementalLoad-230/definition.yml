fileVersion: 1
id: "230"
isDisabled: false
metadata:
  defaultStorageLocation: null
  error: null
  nodeMetadataSpec: |-
    capitalized: INCREMENTAL LOAD
    short: INC
    plural: Incremental
    tagColor: green

    isColumnResyncEnabled: true

    config:
    - groupName: Options
      items:

      - type: materializationSelector
        default: view
        options:
        - view
        - table
        isRequired: true

      - displayName: Filter data based on Persistent Table
        attributeName: refTable
        type: toggleButton
        default: false
        isRequired: false    
        enableIf: "{% if (config.dqhandle) %} false {% else %} true {% endif %}" 

      - displayName: Handle data quality
        attributeName: dqhandle
        type: toggleButton
        default: false
        isRequired: false  
      
      - displayName: Nullability test
        attributeName: dqnull
        type: toggleButton
        default: false
        isRequired: false 
        enableIf: "{% if (config.dqhandle) %} true {% else %} false {% endif %}" 
      
      - type: tabular
        displayName: 'Data Quality-Nullability test'
        attributeName: ndqcolumns
        columns:

        -  type: columnDropdownSelector
           displayName: Column Name
           attributeName: ncolumnName
           isRequired: false     
          
        isRequired: false
        enableIf: "{% if (config.dqhandle and config.dqnull) %} true {% else %} false {% endif %}"

      - displayName: Duplicate test
        attributeName: dqdup
        type: toggleButton
        default: false
        isRequired: false  
        enableIf: "{% if (config.dqhandle) %} true {% else %} false {% endif %}" 

      - type: tabular
        displayName: 'Data Quality-Duplicates test'
        attributeName: ddqcolumns
        columns:

        -  type: columnDropdownSelector
           displayName: Column Name
           attributeName: dcolumnName
           isRequired: false     
          
        isRequired: false
        enableIf: "{% if (config.dqhandle and config.dqdup) %} true {% else %} false {% endif %}"

      - displayName: Persistent table can be a Persistent stage,Dimension or  Fact node
        type: label
        enableIf: "{% if (config.refTable) and not config.dqhandle %} true {% else %} false {% endif %}"

      - displayName: Persistent Table location(Storage location in Coalesce)
        attributeName: persistTableLocation
        type: textBox
        default: "ex: TARGET"
        isRequired: false
        enableIf: "{% if (config.refTable) and not config.dqhandle %} true {% else %} false {% endif %}"

      - displayName: Persistent Table name
        attributeName: persistTableName
        type: textBox
        default: "ex: DIM_ORDERS"
        isRequired: false
        enableIf: "{% if (config.refTable) and not config.dqhandle %} true {% else %} false {% endif %}"

      - displayName: "Incremental Load Column (date)"
        attributeName: incColumn
        type: columnDropdownSelector
        isRequired: false
        enableIf: "{% if (config.refTable) and not config.dqhandle %} true {% else %} false {% endif %}"

      - displayName: Pre-SQL
        attributeName: preSQL
        type: textBox
        syntax: sql
        isRequired: false

      - displayName: Post-SQL
        attributeName: postSQL
        type: textBox
        syntax: sql
        isRequired: false

    joinTemplate: |


      {%- set src = namespace() -%}
      {%- for dep in sources[0].dependencies -%}
        FROM {{ ref_raw(dep.node.location.name, dep.node.name) }} "{{ dep.node.name }}"
        {%- set src.name = dep.node.name -%}
      {%endfor%}
      {%- if config.persistTableName | length > 0 -%}
          {%- set persist = config.persistTableName -%}
      {%- else -%}
          {%- if  config.persistTable | length > 0 %}
            {%- set persist = node.name | replace("INC", config.persistTable) -%}
          {%- else -%}
            {%- set persist = node.name | replace("INC_", config.persistTable) -%}
          {%- endif -%}
      {%- endif -%}
      {%- if config.refTable and persist | length > 0 %}
        WHERE "{{src.name}}"."{{config.incColumn.name}}" > 
        (SELECT COALESCE(MAX("{{config.incColumn.name}}"), '1900-01-01') 
                  FROM {{ref_no_link_raw(config.persistTableLocation, persist)}} )
      {%endif%}
name: Incremental Load
type: NodeType
